<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>在线聊天室</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/4.3.0/css/bootstrap.css}">
    <script th:src="@{/webjars/jquery/3.4.1/jquery.js}"></script>
</head>
<body class="container" style="width: 60%">
<div class="form-group"><br>
    <h5>聊天室</h5>
    <textarea id="message_content" class="form-control" readonly="readonly" cols="50" rows="10"></textarea>
</div>
<div class="form-group">
    <label for="in_room_id">房间号&nbsp;</label>
    <input id="in_room_id" value="" class="form-control"/></br>
    <label for="in_user_name">用户姓名 &nbsp;</label>
    <input id="in_user_name" value="" class="form-control"/></br>

    <button id="user_join" class="btn btn-success" th:onclick="'javascript:joinChat()'">加入聊天室</button>
    <button id="user_exit" class="btn btn-warning">离开聊天室</button>
</div>
<div class="form-group">
    <label for="in_room_msg">群发消息 &nbsp;</label>
    <input id="in_room_msg" value="" class="form-control"/></br>
    <button id="user_send_all" class="btn btn-info" th:onclick ="'javascript:sendMsg()'">发送消息</button>
</div>
</body>
<!--https://blog.csdn.net/qq_36994771/article/details/80085876-->
<!--https://www.cnblogs.com/guoyuchuan/p/9549672.html-->
<!--https://www.cnblogs.com/guoyuchuan/p/9581283.html-->
<script type="text/javascript" th:inline="javascript">
    let user = {};
    let ws ;
    const web_socket_url = "ws://localhost:8888";
    $(document).ready(function () {
        console.log(user);
        const temp = typeof (user);
        console.log(temp);
    });

    function joinChat() {
        console.log("触发joinChat");
        if (window.WebSocket){
            //获取h5websocket
            ws = new WebSocket(web_socket_url);
            console.log(ws);
            // websocket 连接

            ws.onopen =function (data) {
                console.log("ws.onopen");
                user.rommId = $('#in_room_id').val();
                user.userName = $('#in_user_name').val();
                user.message = '10001';
                user.userId = 1;
                console.log(user);

                // 连接成功发送用户信息进入聊天室
                ws.send(JSON.stringify(user));
            };

            ws.onclose = function (data) {
                console.log("ws.onclose");
            };

            ws.onerror = function (data) {
                console.log("ws.onerror")
            };

            ws.onmessage = function (data) {
                console.log("ws.onmessage");
                console.log(data);
                const information = JSON.parse(data.data);
                console.log(information.message);

                if (information.message === '10001') { //10001为上线
                    $('#message_content').append(information.username,"上线了");
                }else if (information.message === '20002'){
                    $('#message_content').append(information.username,"下线了");
                }else if (information.message === '30003'){
                    $('#message_content').append(information.username);
                }else { // 用户发送的消息
                    $('#message_content').append(information.username,":",information.message);
                }
            };
        }else {
            alert("抱歉，您的浏览器暂不支持webSocket");
        }
    }

    function sendMsg() {
        user.message = $('#in_room_msg').val();
        console.log(JSON.stringify(user));
        ws.send(JSON.stringify(user));
    }


</script>
</html>