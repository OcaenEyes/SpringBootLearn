<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>netty简单的聊天室</title>
    <script th:src="@{webjars/jquery/3.4.1/jquery.min.js}"></script>
</head>
<body>
<div id="top">
    <input type="button" value="1" id="button1" οnclick="inChat('1')"/>
    <input type="button" value="2" id="button2" οnclick="inChat('2')"/><br/>
</div>

<div id="bottom">
    <div id="title"></div>
    <div id = 'users'></div>
    <div>
        <input type="text" id="information"/>
        <input type="button" value="发送" οnclick="send()"/>
    </div>
    <div id="message-content" style="height: 300px;width: 500px;border:1px solid;"></div>
</div>
</body>
<script th:inline="javascript">
    let user;
    let socket;
    $(function() {
        $('#bottom').hide();
        user = [[${user}]];
        console.log(user);
        const temp = typeof (user);
        console.log(temp);
    });

    //进入聊天室
    function inChat(num) {
        if (!window.WebSocket) {
            window.WebSocket = window.MozWebSocket;
        }
        if (window.WebSocket) {
            //获取h5 socket
            socket = new WebSocket("ws://127.0.0.1:9099/");
            //接收消息
            socket.onmessage = function(data){
                console.log("socket.onmessage:")
                console.log(data);
                const information = JSON.parse(data.data);
                console.log(information.message);
                if (information.message == '10001') {//10001为上线
                    $('#top').hide();
                    $('#bottom').show();
                    $('#title').text('chat' + information.roomId);
                    $('#users').append('<span>'+ information.userName + '\t</span>');
                    $('#message-content').append('<span>'+ information.userName +'上线</span><br/>');
                } else if (information.message == '20002') {//有人下线
                    const cns = $('#users').children();
                    console.log(cns);
                    for (let i = 0; i < cns.length; i++) {
                        if ($(cns[i]).text() == information.userName + '\t') {
                            $(cns[i]).remove();
                        }
                    }
                    $('#message-content').append('<span>'+ information.userName +'下线</span><br/>');
                } else if (information.message == '30003') {//加载已上线用户
                    $('#users').append('<span>'+ information.userName + '\t</span>');
                } else {//用户发的消息
                    $('#message-content').append('<span>'+ information.userName + ' : ' + information.message + '</span><br/>');
                }
            }
            //webSocket的链接
            socket.onopen = function(data) {
                console.log("socket.onopen:")
                console.log(data);
                user.roomId = num;
                user.message = '10001';
                delete user.pwd;
                console.log(user);
                //链接成功后发送用户信息进入聊天室
                socket.send(JSON.stringify(user));
            }
            //webSocket关闭
            socket.onclose = function(data) {
                console.log("socket.onclose:")
                console.log(data);
            }
            //webSocket错误信息
            socket.onerror = function(data) {
                console.log("socket.onerror:")
                console.log(data);
            }
        } else {
            alert("抱歉，您的浏览器不支持WebSocket协议!");
        }
    }

    //发送消息
    function send() {
        user.message = $('#mag').val();
        socket.send(JSON.stringify(user));
    }
</script>
</html>